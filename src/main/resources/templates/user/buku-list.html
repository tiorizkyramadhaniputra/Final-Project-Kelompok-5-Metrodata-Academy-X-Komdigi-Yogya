<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Daftar Buku</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <style>
        .card-stok-habis {
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="text-center mb-4">ðŸ“š Daftar Buku</h2>
    <div class="row" id="daftarBuku"></div>
</div>

<div class="modal fade" id="modalPinjam" tabindex="-1" aria-labelledby="modalPinjamLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPinjamLabel">Konfirmasi Peminjaman</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="judulBuku"></p>
                <div class="mb-3">
                    <label class="form-label">Nama Peminjam</label>
                    <input type="text" id="namaPeminjam" class="form-control" placeholder="Masukkan nama kamu">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btnKonfirmasiPinjam">Pinjam</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let selectedBookId = null;

// URL base API Anda
const API_BASE_URL = "http://localhost:9001/api"; 

async function loadBuku() {
    // PERBAIKAN 1: Menggunakan KatalogApiController yang baru dibuat
    const res = await fetch(API_BASE_URL + "/katalog/buku"); 
    
    // Check jika fetch gagal (misalnya 404)
    if (!res.ok) {
        document.getElementById("daftarBuku").innerHTML = `<p class="text-danger">Gagal memuat daftar buku dari API.</p>`;
        return;
    }

    const data = await res.json();

    const container = document.getElementById("daftarBuku");
    container.innerHTML = "";

    data.forEach(buku => {
        const isStokHabis = buku.stok <= 0;
        const cardClass = isStokHabis ? "card shadow-sm card-stok-habis" : "card shadow-sm";

        container.innerHTML += `
            <div class="col-md-4 mb-4">
                <div class="${cardClass}">
                    <div class="card-body">
                        <h5>${buku.judul}</h5>
                        <p><b>Penulis:</b> ${buku.penulis}</p>
                        <p><b>Kategori:</b> ${buku.kategori}</p>
                        <p><b>Stok:</b> ${buku.stok}</p>
                        <button class="btn btn-primary" 
                                onclick="bukaModal(${buku.id}, '${buku.judul}')"
                                ${isStokHabis ? 'disabled' : ''}>
                            ${isStokHabis ? 'Stok Habis' : 'Pinjam'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
}

function bukaModal(id, judul) {
    selectedBookId = id;
    document.getElementById("judulBuku").innerText = "Buku: " + judul;
    document.getElementById("namaPeminjam").value = ""; // Bersihkan field nama
    new bootstrap.Modal(document.getElementById("modalPinjam")).show();
}

document.getElementById("btnKonfirmasiPinjam").addEventListener("click", async () => {
    const nama = document.getElementById("namaPeminjam").value;
    
    if (!nama) {
        alert("Nama peminjam harus diisi!");
        return;
    }
    
    // PERBAIKAN 2: Mengirim DTO yang sesuai dengan UserPeminjamanApiController.java
    const peminjamanData = {
        namaPeminjam: nama,
        bukuId: selectedBookId // Mengirim ID buku sebagai bukuId
    };

    try {
        const response = await fetch(API_BASE_URL + "/peminjaman/save", { // Jalur API yang benar
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(peminjamanData)
        });

        if (response.ok) {
            alert("Peminjaman berhasil dicatat! Silakan cek riwayat admin.");
            bootstrap.Modal.getInstance(document.getElementById("modalPinjam")).hide();
            loadBuku(); // Refresh daftar buku untuk update stok
        } else if (response.status === 400) {
            // Menangkap error stok habis dari backend
             const errorData = await response.json(); 
             alert("Gagal: " + (errorData.message || "Stok buku habis atau kesalahan permintaan."));
        } else {
            alert("Terjadi kesalahan saat meminjam buku. Status: " + response.status);
            console.error("Backend Error Response:", await response.text());
        }
    } catch (error) {
        console.error("Fetch error:", error);
        alert("Terjadi kesalahan koneksi server.");
    }
});

loadBuku();
</script>
</body>
</html>