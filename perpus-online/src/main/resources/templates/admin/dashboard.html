<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>Admin - Kelola Buku</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    </head>
<body>
<div class="container-fluid">
    <div class="row mt-4">
        <div class="col-2 sidebar p-4">
            <h5>Perpus</h5>
            <a href="/admin/buku" class="d-block text-white mb-2">Dashboard</a>
            <a href="/admin/peminjaman" class="d-block text-white mb-2">Peminjaman</a>
            <a href="/logout" class="d-block text-white mt-4">Logout</a>
        </div>
        <div class="col-10">
            <div class="card card-soft p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Kelola Buku</h3>
                    <button class="btn btn-blue" data-bs-toggle="modal" data-bs-target="#modalAdd">Tambah Buku</button>
                </div>

                <table id="tabelBuku" class="display table table-striped" style="width:100%"></table>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAdd" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Tambah Buku</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formBuku"> 
                    <input type="hidden" name="id" id="id">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Judul</label>
                            <input class="form-control" name="judul" id="judul" required>
                            <label>Penulis</label>
                            <input class="form-control" name="penulis" id="penulis" required>
                            <label>Penerbit</label>
                            <input class="form-control" name="penerbit" id="penerbit" required>
                            <label>Tahun</label>
                            <input class="form-control" name="tahun" id="tahun" type="number">
                        </div>
                        <div class="col-md-6">
                            <label>Kategori</label>
                            <input class="form-control" name="kategori" id="kategori">
                            <label>Stok</label>
                            <input class="form-control" name="stok" id="stok" type="number">
                            <label>Deskripsi</label>
                            <textarea class="form-control" name="deskripsi" id="deskripsi"></textarea>
                            </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="btnSave">Simpan</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function() {
    const table = $('#tabelBuku').DataTable({
        ajax: {
            // PERBAIKAN: URL Absolut API untuk READ data
            url: '/api/admin/buku/data', 
            dataSrc: ''
        },
        columns: [
            { data: 'id', title: 'ID' },
            { data: 'judul', title: 'Judul' },
            { data: 'penulis', title: 'Penulis' },
            { data: 'kategori', title: 'Kategori' },
            { data: 'stok', title: 'Stok' },
            { data: 'gambar', title: 'Gambar', render: d => d ? `<img src='/images/${d}' width='50'>` : '-' },
            { data: null, title: 'Aksi', render: d => `
                <button class='btn btn-sm btn-warning btnEdit' data-id='${d.id}'>Edit</button>
                <button class='btn btn-sm btn-danger btnDelete' data-id='${d.id}'>Hapus</button>`}
        ]
    });

    // Save or update
    $('#btnSave').click(function() {
        const id = $('#id').val();
        const method = id ? 'PUT' : 'POST';
        
        // PERBAIKAN: URL Absolut API untuk CREATE/UPDATE data
        const url = id ? `/api/admin/buku/update/${id}` : '/api/admin/buku/save'; 
        
        // Kumpulkan data ke dalam objek JavaScript (JSON)
        const bukuData = {
            id: id || null,
            judul: $('#judul').val(),
            penulis: $('#penulis').val(),
            penerbit: $('#penerbit').val(),
            tahun: $('#tahun').val(),
            kategori: $('#kategori').val(),
            stok: $('#stok').val(),
            deskripsi: $('#deskripsi').val()
        };

        $.ajax({
            url: url,
            type: method,
            data: JSON.stringify(bukuData), // Mengirim sebagai string JSON
            contentType: 'application/json', // Memberi tahu server bahwa ini adalah JSON
            
            success: function() {
                $('#modalAdd').modal('hide');
                table.ajax.reload();
                $('#formBuku')[0].reset();
                $('#modalTitle').text('Tambah Buku');
                $('#id').val('');
            },
            error: function(xhr, status, error) {
                console.error("Error saving/updating book:", xhr.responseText);
                alert("Gagal menyimpan/memperbarui buku. Cek konsol browser.");
            }
        });
    });

    // Edit 
    $('#tabelBuku').on('click', '.btnEdit', function() {
        const data = table.row($(this).parents('tr')).data();
        $('#modalTitle').text('Edit Buku');
        $('#id').val(data.id);
        $('#judul').val(data.judul);
        $('#penulis').val(data.penulis);
        $('#penerbit').val(data.penerbit);
        $('#tahun').val(data.tahun);
        $('#kategori').val(data.kategori);
        $('#stok').val(data.stok);
        $('#deskripsi').val(data.deskripsi);
        $('#modalAdd').modal('show');
    });

    // Delete
    $('#tabelBuku').on('click', '.btnDelete', function() {
        if (confirm('Yakin hapus data ini?')) {
            // PERBAIKAN: URL Absolut API untuk DELETE data
            $.ajax({ 
                url: `/api/admin/buku/delete/${$(this).data('id')}`, 
                type: 'DELETE', 
                success: () => table.ajax.reload(),
                error: function(xhr, status, error) {
                    console.error("Error deleting book:", xhr.responseText);
                    alert("Gagal menghapus buku. Cek konsol browser.");
                }
            });
        }
    });
});
</script>
</body>
</html>